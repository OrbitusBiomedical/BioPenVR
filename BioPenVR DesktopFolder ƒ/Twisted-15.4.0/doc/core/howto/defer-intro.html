<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Introduction to Deferreds &mdash; Twisted 15.4.0 documentation</title>
    <link rel="stylesheet" href="../../_static/twistedtrac.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '15.4.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Twisted 15.4.0 documentation" href="../../index.html" />
    <link rel="up" title="Developer Guides" href="index.html" />
    <link rel="next" title="Deferred Reference" href="defer.html" />
    <link rel="prev" title="Using Processes" href="process.html" /> 
    
<!-- Can stuff between these comments go? -->
        <link rel="search" href="/trac/search" />
        <link rel="help" href="/trac/wiki/TracGuide" />
        <link rel="alternate" href="/trac/wiki/Documentation?format=txt" type="text/x-trac-wiki" title="Plain Text" />
        <link rel="start" href="/trac/wiki" />

        
    <script type="text/javascript" src="/trac/chrome/common/js/jquery.js"></script><script type="text/javascript" src="/trac/chrome/common/js/trac.js"></script><script type="text/javascript" src="/trac/chrome/common/js/search.js"></script>
    
    <!-- the following script tag is a holdover frome Trac, which shouldn't be needed in Sphinx
    <script type="text/javascript">
      $(document).ready(function() {
        $("#content").find("h1,h2,h3,h4,h5,h6").addAnchor("Link to this section");
      });
    </script>
    -->
<!-- Can stuff between these comments go? -->

  </head>
  
  
<body>

<div id="banner">
<div id="top_grad">
         
</div>
<div id="tab">
        <a href="http://twistedmatrix.com/trac/wiki">HOME</a>
    <a href="http://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
    <a href="/">DOCS</a>
    <a href="http://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>

</div>
      <div id="header">
        <a id="logo" href="http://twistedmatrix.com/trac/"><img src="../../_static/trac_banner.png" alt="Twisted" /></a>
      </div>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <form id="topsearch" action="/trac/search" method="get"><div>
        <label for="proj-search">Search:</label>
        <input type="text" id="proj-search" name="q" size="10" value="" />
        <input type="submit" value="Search" />
        <input type="hidden" name="wiki" value="on" />

        <input type="hidden" name="changeset" value="on" />
        <input type="hidden" name="ticket" value="on" />
      </div></form>
      -->
      <div id="metanav" class="nav">
    <ul>
      <li> </li>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <li class="first">logged in as khorn</li><li class=""><a href="/trac/logout">Logout</a></li><li class=""><a href="/trac/wiki/TracGuide">Help/Guide</a></li><li class=""><a href="/trac/about">About Trac</a></li><li class="last"><a href="/trac/account">My Account</a></li>
      -->
    </ul>
  </div>
    </div>

<!-- mainnav -->
    <div id="mainnav" class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="defer.html" title="Deferred Reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="process.html" title="Using Processes"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Twisted 15.4.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Twisted Core</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Developer Guides</a> &raquo;</li> 
      </ul>
    </div>

    <div id="main">
    <div id="ctxtnav" class="nav">
      <h2>Wiki Navigation</h2>
      <ul>
        <li>
        
        </li>
        <!-- taking this out for now, but might use 
             the space for something else later 
        -->
        <!--
        <li><a href="/trac/wiki/WikiStart">Start Page</a></li>
        <li><a href="/trac/wiki/TitleIndex">Index by Title</a></li>

        <li><a href="/trac/wiki/RecentChanges">Index by Date</a></li>
        <li class="last">
          <a href="/trac/wiki/Documentation?action=diff&amp;version=15">Last Change</a>
        </li>
        -->
      </ul>
      <hr />
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div id="current-docs-container" style="display: none">
            <em>
              <a id="current-docs-link">
                Go to the latest version of this document.
              </a>
            </em>
          </div>
          <div class="body">
            
  <div class="section" id="introduction-to-deferreds">
<h1>Introduction to Deferreds<a class="headerlink" href="#introduction-to-deferreds" title="Permalink to this headline">¶</a></h1>
<p>This document introduces <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s, Twisted&#8217;s preferred mechanism for controlling the flow of asynchronous code.
Don&#8217;t worry if you don&#8217;t know what that means yet &#8211; that&#8217;s why you are here!</p>
<p>It is intended for newcomers to Twisted, and was written particularly to help people read and understand code that already uses <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s.</p>
<p>This document assumes you have a good working knowledge of Python.
It assumes no knowledge of Twisted.</p>
<p>By the end of the document, you should understand what <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s are and how they can be used to coordinate asynchronous code.
In particular, you should be able to:</p>
<ul class="simple">
<li>Read and understand code that uses <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s</li>
<li>Translate from synchronous code to asynchronous code and back again</li>
<li>Implement any sort of error-handling for asynchronous code that you wish</li>
</ul>
<div class="section" id="the-joy-of-order">
<h2>The joy of order<a class="headerlink" href="#the-joy-of-order" title="Permalink to this headline">¶</a></h2>
<p>When you write Python code, one prevailing, deep, unassailled assumption is that a line of code within a block is only ever executed after the preceding line is finished.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">pod_bay_doors</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">pod</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
</pre></div>
</div>
<p>The pod bay doors open, and only <em>then</em> does the pod launch.
That&#8217;s wonderful.
One-line-after-another is a built-in mechanism in the language for encoding the order of execution.
It&#8217;s clear, terse, and unambiguous.</p>
<p>Exceptions make things more complicated.
If <code class="docutils literal"><span class="pre">pod_bay_doors.open()</span></code> raises an exception, then we cannot know with certainty that it completed, and so it would be wrong to proceed blithely to the next line.
Thus, Python gives us <code class="docutils literal"><span class="pre">try</span></code>, <code class="docutils literal"><span class="pre">except</span></code>, <code class="docutils literal"><span class="pre">finally</span></code>, and <code class="docutils literal"><span class="pre">else</span></code>, which together model almost every conceivable way of handling a raised exception, and tend to work really well.</p>
<p>Function application is the other way we encode order of execution:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">pprint</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()))</span>
</pre></div>
</div>
<p>First <code class="docutils literal"><span class="pre">x.get_names()</span></code> gets called, then <code class="docutils literal"><span class="pre">sorted</span></code> is called with its return value, and then <code class="docutils literal"><span class="pre">pprint</span></code> with whatever <code class="docutils literal"><span class="pre">sorted</span></code> returns.</p>
<p>It can also be written as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">names</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>
<span class="n">sorted_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">sorted_names</span><span class="p">)</span>
</pre></div>
</div>
<p>Sometimes it leads us to encode the order when we don&#8217;t need to, as in this example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">accounts</span><span class="p">:</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">account</span><span class="o">.</span><span class="n">get_balance</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&quot;Total balance $</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total</span><span class="p">,)</span>
</pre></div>
</div>
<p>But that&#8217;s normally not such a big deal.</p>
<p>All in all, things are pretty good, and all of the explanation above is laboring familiar and obvious points.
One line comes after another and one thing happens after another, and both facts are inextricably tied.</p>
<p>But what if we had to do it differently?</p>
</div>
<div class="section" id="a-hypothetical-problem">
<h2>A hypothetical problem<a class="headerlink" href="#a-hypothetical-problem" title="Permalink to this headline">¶</a></h2>
<p>What if we could no longer rely on the previous line of code being finished (whatever that means) before we started to interpret &amp; execute the next line of code?
What if <code class="docutils literal"><span class="pre">pod_bay_doors.open()</span></code> returned immediately, triggering something somewhere else that would eventually open the pod bay doors, recklessly sending the Python interpreter plunging into <code class="docutils literal"><span class="pre">pod.launch()</span></code> ?</p>
<p>That is, what would we do if the order of execution did not match the order of lines of Python?
If &#8220;returning&#8221; no longer meant &#8220;finishing&#8221;?</p>
<p><em>Asynchronous operations</em>?</p>
<p>How would we prevent our pod from hurtling into the still-closed doors?
How could we respond to a potential failure to open the doors at all?
What if opening the doors gave us some crucial information that we needed in order to launch the pod?
How would we get access to that information?</p>
<p>And, crucially, since we are writing code, how can we write our code so that we can build <em>other</em> code on top of it?</p>
</div>
<div class="section" id="the-components-of-a-solution">
<h2>The components of a solution<a class="headerlink" href="#the-components-of-a-solution" title="Permalink to this headline">¶</a></h2>
<p>We would still need a way of saying &#8220;do <em>this</em> only when <em>that</em> has finished&#8221;.</p>
<p>We would need a way of distinguishing between successful completion and interrupted processing, normally modeled with <code class="docutils literal"><span class="pre">try</span></code>, <code class="docutils literal"><span class="pre">expect</span></code>, <code class="docutils literal"><span class="pre">else</span></code>, and <code class="docutils literal"><span class="pre">finally</span></code>.</p>
<p>We need a mechanism for getting return failures and exception information from the thing that just executed to the thing that needs to happen next.</p>
<p>We need somehow to be able to operate on results that we don&#8217;t have yet.
Instead of acting, we need to make and encode plans for how we would act if we could.</p>
<p>Unless we hack the interpreter somehow, we would need to build this with the Python language constructs we are given: methods, functions, objects, and the like.</p>
<p>Perhaps we want something that looks a little like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">placeholder</span> <span class="o">=</span> <span class="n">pod_bay_doors</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">placeholder</span><span class="o">.</span><span class="n">when_done</span><span class="p">(</span><span class="n">pod</span><span class="o">.</span><span class="n">launch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="one-solution-deferred">
<h2>One solution: Deferred<a class="headerlink" href="#one-solution-deferred" title="Permalink to this headline">¶</a></h2>
<p>Twisted tackles this problem with <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s, a type of object designed to do one thing, and one thing only: encode an order of execution separately from the order of lines in Python source code.</p>
<p>It doesn&#8217;t deal with threads, parallelism, signals, or subprocesses.
It doesn&#8217;t know anything about an event loop, greenlets, or scheduling.
All it knows about is what order to do things in.
How does it know that?
Because we explicitly tell it the order that we want.</p>
<p>Thus, instead of writing:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">pod_bay_doors</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">pod</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
</pre></div>
</div>
<p>We write:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">pod_bay_doors</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ignored</span><span class="p">:</span> <span class="n">pod</span><span class="o">.</span><span class="n">launch</span><span class="p">())</span>
</pre></div>
</div>
<p>That introduced a dozen new concepts in a couple of lines of code, so let&#8217;s break it down.
If you think you&#8217;ve got it, you might want to skip to the next section.</p>
<p>Here, <code class="docutils literal"><span class="pre">pod_bay_doors.open()</span></code> is returning a <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>, which we assign to <code class="docutils literal"><span class="pre">d</span></code>.
We can think of <code class="docutils literal"><span class="pre">d</span></code> as a placeholder, representing the value that <code class="docutils literal"><span class="pre">open()</span></code> will eventually return when it finally gets around to finishing.</p>
<p>To &#8220;do this next&#8221;, we add a <em>callback</em> to <code class="docutils literal"><span class="pre">d</span></code>.
A callback is a function that will be called with whatever <code class="docutils literal"><span class="pre">open()</span></code> eventually returns.
In this case, we don&#8217;t care, so we make a function with a single, ignored parameter that just calls <code class="docutils literal"><span class="pre">pod.launch()</span></code>.</p>
<p>So, we&#8217;ve replaced the &#8220;order of lines is order of execution&#8221; with a deliberate, in-Python encoding of the order of execution, where <code class="docutils literal"><span class="pre">d</span></code> represents the particular flow and <code class="docutils literal"><span class="pre">d.addCallback</span></code> replaces &#8220;new line&#8221;.</p>
<p>Of course, programs generally consist of more than two lines, and we still don&#8217;t know how to deal with failure.</p>
</div>
<div class="section" id="getting-it-right-the-failure-cases">
<h2>Getting it right: The failure cases<a class="headerlink" href="#getting-it-right-the-failure-cases" title="Permalink to this headline">¶</a></h2>
<p>In what follows, we are going to take each way of expressing order of operations in normal Python (using lines of code and <code class="docutils literal"><span class="pre">try</span></code>/<code class="docutils literal"><span class="pre">except</span></code>) and translate them into an equivalent code built with <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a> objects.</p>
<p>This is going to be a bit painstaking, but if you want to really understand how to use <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s and maintain code that uses them, it is worth understanding each example below.</p>
<div class="section" id="one-thing-then-another-then-another">
<h3>One thing, then another, then another<a class="headerlink" href="#one-thing-then-another-then-another" title="Permalink to this headline">¶</a></h3>
<p>Recall our example from earlier:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">pprint</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()))</span>
</pre></div>
</div>
<p>Also written as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">names</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>
<span class="n">sorted_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">sorted_names</span><span class="p">)</span>
</pre></div>
</div>
<p>What if neither <code class="docutils literal"><span class="pre">get_names</span></code> nor <code class="docutils literal"><span class="pre">sorted</span></code> can be relied on to finish before they return?
That is, if both are asynchronous operations?</p>
<p>Well, in Twisted-speak they would return <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s and so we would write:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="nb">sorted</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">pprint</span><span class="p">)</span>
</pre></div>
</div>
<p>Eventually, <code class="docutils literal"><span class="pre">sorted</span></code> will get called with whatever <code class="docutils literal"><span class="pre">get_names</span></code> finally delivers.
When <code class="docutils literal"><span class="pre">sorted</span></code> finishes, <code class="docutils literal"><span class="pre">pprint</span></code> will be called with whatever it delivers.</p>
<p>We could also write this as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="nb">sorted</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">pprint</span><span class="p">)</span>
</pre></div>
</div>
<p>Since <code class="docutils literal"><span class="pre">d.addCallback</span></code> returns <code class="docutils literal"><span class="pre">d</span></code>.</p>
</div>
<div class="section" id="simple-failure-handling">
<h3>Simple failure handling<a class="headerlink" href="#simple-failure-handling" title="Permalink to this headline">¶</a></h3>
<p>We often want to write code equivalent to this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">report_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>How would we write this with <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s?</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">report_error</span><span class="p">)</span>
</pre></div>
</div>
<p><em>errback</em> is the Twisted name for a callback that is called when an error is received.</p>
<p>This glosses over an important detail.
Instead of getting the exception object <code class="docutils literal"><span class="pre">e</span></code>, <code class="docutils literal"><span class="pre">report_error</span></code> would get a <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.python.failure.Failure.html">Failure</a> object, which has all of the useful information that <code class="docutils literal"><span class="pre">e</span></code> does, but is optimized for use with <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s.</p>
<p>We&#8217;ll dig into that a bit later, after we&#8217;ve dealt with all of the other combinations of exceptions.</p>
</div>
<div class="section" id="handle-an-error-but-do-something-else-on-success">
<h3>Handle an error, but do something else on success<a class="headerlink" href="#handle-an-error-but-do-something-else-on-success" title="Permalink to this headline">¶</a></h3>
<p>What if we want to do something after our <code class="docutils literal"><span class="pre">try</span></code> block if it actually worked?
Abandoning our contrived examples and reaching for generic variable names, we get:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">g</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>Well, we&#8217;d write it like this with <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<p>Where <code class="docutils literal"><span class="pre">addCallbacks</span></code> means &#8220;add a callback and an errback at the same time&#8221;.
<code class="docutils literal"><span class="pre">h</span></code> is the callback, <code class="docutils literal"><span class="pre">g</span></code> is the errback.</p>
<p>Now that we have <code class="docutils literal"><span class="pre">addCallbacks</span></code> along with <code class="docutils literal"><span class="pre">addErrback</span></code> and <code class="docutils literal"><span class="pre">addCallback</span></code>, we can match any possible combination of <code class="docutils literal"><span class="pre">try</span></code>, <code class="docutils literal"><span class="pre">except</span></code>, <code class="docutils literal"><span class="pre">else</span></code>, and <code class="docutils literal"><span class="pre">finally</span></code> by varying the order in which we call them.
Explaining exactly how it works is tricky (although the <a class="reference internal" href="defer.html"><span class="doc">Deferred reference</span></a> does rather a good job), but once we&#8217;re through all of the examples it ought to be clearer.</p>
</div>
<div class="section" id="handle-an-error-then-proceed-anyway">
<h3>Handle an error, then proceed anyway<a class="headerlink" href="#handle-an-error-then-proceed-anyway" title="Permalink to this headline">¶</a></h3>
<p>What if we want to do something after our <code class="docutils literal"><span class="pre">try</span></code>/<code class="docutils literal"><span class="pre">except</span></code> block, regardless of whether or not there was an exception?
That is, what if we wanted to do the equivalent of this generic code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>And with <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
<p>Because <code class="docutils literal"><span class="pre">addErrback</span></code> returns <code class="docutils literal"><span class="pre">d</span></code>, we can chain the calls like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">f</span><span class="p">()</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
<p>The order of <code class="docutils literal"><span class="pre">addErrback</span></code> and <code class="docutils literal"><span class="pre">addCallback</span></code> matters.
In the next section, we can see what would happen when we swap them around.</p>
</div>
<div class="section" id="handle-an-error-for-the-entire-operation">
<h3>Handle an error for the entire operation<a class="headerlink" href="#handle-an-error-for-the-entire-operation" title="Permalink to this headline">¶</a></h3>
<p>What if we want to wrap up a multi-step operation in one exception handler?</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">g</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>With <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s, it would look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<p>Or, more succinctly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="do-something-regardless">
<h3>Do something regardless<a class="headerlink" href="#do-something-regardless" title="Permalink to this headline">¶</a></h3>
<p>What about <code class="docutils literal"><span class="pre">finally</span></code>?
How do we do something regardless of whether or not there was an exception?
How do we translate this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">g</span><span class="p">()</span>
</pre></div>
</div>
<p>Well, roughly we do this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addBoth</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<p>This adds <code class="docutils literal"><span class="pre">g</span></code> as both the callback and the errback.
It is equivalent to:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<p>Why &#8220;roughly&#8221;?
Because if <code class="docutils literal"><span class="pre">f</span></code> raises, <code class="docutils literal"><span class="pre">g</span></code> will be passed a <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.python.failure.Failure.html">Failure</a> object representing the exception.
Otherwise, <code class="docutils literal"><span class="pre">g</span></code> will be passed the asynchronous equivalent of the return value of <code class="docutils literal"><span class="pre">f()</span></code> (i.e. <code class="docutils literal"><span class="pre">y</span></code>).</p>
</div>
<div class="section" id="inline-callbacks-using-yield">
<h3>Inline callbacks - using &#8216;yield&#8217;<a class="headerlink" href="#inline-callbacks-using-yield" title="Permalink to this headline">¶</a></h3>
<p>Twisted features a decorator named <code class="docutils literal"><span class="pre">inlineCallbacks</span></code> which allows you to work with Deferreds without writing callback functions.</p>
<p>This is done by writing your code as generators, which <em>yield</em> <code class="docutils literal"><span class="pre">Deferred</span></code>s instead of attaching callbacks.</p>
<p>Consider the following function written in the traditional <code class="docutils literal"><span class="pre">Deferred</span></code> style:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">getUsers</span><span class="p">():</span>
   <span class="n">d</span> <span class="o">=</span> <span class="n">makeRequest</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;/users&quot;</span><span class="p">)</span>
   <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>using <code class="docutils literal"><span class="pre">inlineCallbacks</span></code>, we can write this as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">inlineCallbacks</span><span class="p">,</span> <span class="n">returnValue</span>

<span class="nd">@inlineCallbacks</span>
<span class="k">def</span> <span class="nf">getUsers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">responseBody</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">makeRequest</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;/users&quot;</span><span class="p">)</span>
    <span class="n">returnValue</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">responseBody</span><span class="p">))</span>
</pre></div>
</div>
<p>a couple of things are happening here:</p>
<ol class="arabic simple">
<li>instead of calling <code class="docutils literal"><span class="pre">addCallback</span></code> on the <code class="docutils literal"><span class="pre">Deferred</span></code> returned by <code class="docutils literal"><span class="pre">makeRequest</span></code>, we <em>yield</em> it.
This causes Twisted to return the <code class="docutils literal"><span class="pre">Deferred</span></code>&#8216;s result to us.</li>
<li>we use <code class="docutils literal"><span class="pre">returnValue</span></code> to propagate the final result of our function.
Because this function is a generator, we cannot use the return statement; that would be a syntax error.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 15.0.</span></p>
</div>
<p class="last">On Python 3.3 and above, instead of writing <code class="docutils literal"><span class="pre">returnValue(json.loads(responseBody))</span></code> you can instead write <code class="docutils literal"><span class="pre">return</span> <span class="pre">json.loads(responseBody)</span></code>.
This can be a significant readability advantage, but unfortunately if you need compatibility with Python 2, this isn&#8217;t an option.</p>
</div>
<p>Both versions of <code class="docutils literal"><span class="pre">getUsers</span></code> present exactly the same API to their callers: both return a <code class="docutils literal"><span class="pre">Deferred</span></code> that fires with the parsed JSON body of the request.
Though the <code class="docutils literal"><span class="pre">inlineCallbacks</span></code> version looks like synchronous code, which blocks while waiting for the request to finish, each <code class="docutils literal"><span class="pre">yield</span></code> statement allows other code to run while waiting for the <code class="docutils literal"><span class="pre">Deferred</span></code> being yielded to fire.</p>
<p><code class="docutils literal"><span class="pre">inlineCallbacks</span></code> become even more powerful when dealing with complex control flow and error handling.
For example, what if <code class="docutils literal"><span class="pre">makeRequest</span></code> fails due to a connection error?
For the sake of this example, let&#8217;s say we want to log the exception and return an empty list.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">getUsers</span><span class="p">():</span>
   <span class="n">d</span> <span class="o">=</span> <span class="n">makeRequest</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;/users&quot;</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">connectionError</span><span class="p">(</span><span class="n">failure</span><span class="p">):</span>
       <span class="n">failure</span><span class="o">.</span><span class="n">trap</span><span class="p">(</span><span class="n">ConnectionError</span><span class="p">)</span>
       <span class="n">log</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="s">&quot;makeRequest failed due to connection error&quot;</span><span class="p">,</span>
                   <span class="n">failure</span><span class="p">)</span>
       <span class="k">return</span> <span class="p">[]</span>

   <span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">,</span> <span class="n">connectionError</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>With <code class="docutils literal"><span class="pre">inlineCallbacks</span></code>, we can rewrite this as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@inlineCallbacks</span>
<span class="k">def</span> <span class="nf">getUsers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">responseBody</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">makeRequest</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;/users&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConnectionError</span><span class="p">:</span>
       <span class="n">log</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="s">&quot;makeRequest failed due to connection error&quot;</span><span class="p">)</span>
       <span class="n">returnValue</span><span class="p">([])</span>

    <span class="n">returnValue</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">responseBody</span><span class="p">))</span>
</pre></div>
</div>
<p>Our exception handling is simplified because we can use Python&#8217;s familiar <code class="docutils literal"><span class="pre">try</span></code> / <code class="docutils literal"><span class="pre">except</span></code> syntax for handling <code class="docutils literal"><span class="pre">ConnectionError</span></code>s.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>You have been introduced to asynchronous code and have seen how to use <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>s to:</p>
<ul class="simple">
<li>Do something after an asynchronous operation completes successfully</li>
<li>Use the result of a successful asynchronous operation</li>
<li>Catch errors in asynchronous operations</li>
<li>Do one thing if an operation succeeds, and a different thing if it fails</li>
<li>Do something after an error has been handled successfully</li>
<li>Wrap multiple asynchronous operations with one error handler</li>
<li>Do something after an asynchronous operation, regardless of whether it succeeded or failed</li>
<li>Write code without callbacks using <code class="docutils literal"><span class="pre">inlineCallbacks</span></code></li>
</ul>
<p>These are very basic uses of <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.defer.Deferred.html">Deferred</a>.
For detailed information about how they work, how to combine multiple Deferreds, and how to write code that mixes synchronous and asynchronous APIs, see the <a class="reference internal" href="defer.html"><span class="doc">Deferred reference</span></a>.
Alternatively, read about how to write functions that <a class="reference internal" href="gendefer.html"><span class="doc">generate Deferreds</span></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Introduction to Deferreds</a><ul>
<li><a class="reference internal" href="#the-joy-of-order">The joy of order</a></li>
<li><a class="reference internal" href="#a-hypothetical-problem">A hypothetical problem</a></li>
<li><a class="reference internal" href="#the-components-of-a-solution">The components of a solution</a></li>
<li><a class="reference internal" href="#one-solution-deferred">One solution: Deferred</a></li>
<li><a class="reference internal" href="#getting-it-right-the-failure-cases">Getting it right: The failure cases</a><ul>
<li><a class="reference internal" href="#one-thing-then-another-then-another">One thing, then another, then another</a></li>
<li><a class="reference internal" href="#simple-failure-handling">Simple failure handling</a></li>
<li><a class="reference internal" href="#handle-an-error-but-do-something-else-on-success">Handle an error, but do something else on success</a></li>
<li><a class="reference internal" href="#handle-an-error-then-proceed-anyway">Handle an error, then proceed anyway</a></li>
<li><a class="reference internal" href="#handle-an-error-for-the-entire-operation">Handle an error for the entire operation</a></li>
<li><a class="reference internal" href="#do-something-regardless">Do something regardless</a></li>
<li><a class="reference internal" href="#inline-callbacks-using-yield">Inline callbacks - using &#8216;yield&#8217;</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="process.html"
                                  title="previous chapter">Using Processes</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="defer.html"
                                  title="next chapter">Deferred Reference</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../../_sources/core/howto/defer-intro.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../search.html" method="get">
                <p>
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
                </p>
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    </div>
    <div id="footer"><hr />
      <div>

</div>
      <p class="left2">
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

      </p>
      <p class="right"></p>
    </div>
    <script type="text/javascript">
      if (window.location.pathname.indexOf('/current/') == -1) {
          <!-- Give the user a link to this page, but in the current version of the docs. -->
          var link = document.getElementById('current-docs-link');
          link.href = window.location.pathname.replace(/\/\d+\.\d+\.\d+/, '/current');
          <!-- And make it visible -->
          var container = document.getElementById('current-docs-container');
          container.style.display = '';
          delete link;
          delete container;
      }
    </script>
  </body>
</html>