<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Writing tests for Twisted code using Trial &mdash; Twisted 15.4.0 documentation</title>
    <link rel="stylesheet" href="../../_static/twistedtrac.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '15.4.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Twisted 15.4.0 documentation" href="../../index.html" />
    <link rel="up" title="Developer Guides" href="index.html" />
    <link rel="next" title="Extremely Low-Level Socket Operations" href="sendmsg.html" />
    <link rel="prev" title="DirDBM: Directory-based Storage" href="dirdbm.html" /> 
    
<!-- Can stuff between these comments go? -->
        <link rel="search" href="/trac/search" />
        <link rel="help" href="/trac/wiki/TracGuide" />
        <link rel="alternate" href="/trac/wiki/Documentation?format=txt" type="text/x-trac-wiki" title="Plain Text" />
        <link rel="start" href="/trac/wiki" />

        
    <script type="text/javascript" src="/trac/chrome/common/js/jquery.js"></script><script type="text/javascript" src="/trac/chrome/common/js/trac.js"></script><script type="text/javascript" src="/trac/chrome/common/js/search.js"></script>
    
    <!-- the following script tag is a holdover frome Trac, which shouldn't be needed in Sphinx
    <script type="text/javascript">
      $(document).ready(function() {
        $("#content").find("h1,h2,h3,h4,h5,h6").addAnchor("Link to this section");
      });
    </script>
    -->
<!-- Can stuff between these comments go? -->

  </head>
  
  
<body>

<div id="banner">
<div id="top_grad">
         
</div>
<div id="tab">
        <a href="http://twistedmatrix.com/trac/wiki">HOME</a>
    <a href="http://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
    <a href="/">DOCS</a>
    <a href="http://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>

</div>
      <div id="header">
        <a id="logo" href="http://twistedmatrix.com/trac/"><img src="../../_static/trac_banner.png" alt="Twisted" /></a>
      </div>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <form id="topsearch" action="/trac/search" method="get"><div>
        <label for="proj-search">Search:</label>
        <input type="text" id="proj-search" name="q" size="10" value="" />
        <input type="submit" value="Search" />
        <input type="hidden" name="wiki" value="on" />

        <input type="hidden" name="changeset" value="on" />
        <input type="hidden" name="ticket" value="on" />
      </div></form>
      -->
      <div id="metanav" class="nav">
    <ul>
      <li> </li>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <li class="first">logged in as khorn</li><li class=""><a href="/trac/logout">Logout</a></li><li class=""><a href="/trac/wiki/TracGuide">Help/Guide</a></li><li class=""><a href="/trac/about">About Trac</a></li><li class="last"><a href="/trac/account">My Account</a></li>
      -->
    </ul>
  </div>
    </div>

<!-- mainnav -->
    <div id="mainnav" class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="sendmsg.html" title="Extremely Low-Level Socket Operations"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="dirdbm.html" title="DirDBM: Directory-based Storage"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Twisted 15.4.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Twisted Core</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Developer Guides</a> &raquo;</li> 
      </ul>
    </div>

    <div id="main">
    <div id="ctxtnav" class="nav">
      <h2>Wiki Navigation</h2>
      <ul>
        <li>
        
        </li>
        <!-- taking this out for now, but might use 
             the space for something else later 
        -->
        <!--
        <li><a href="/trac/wiki/WikiStart">Start Page</a></li>
        <li><a href="/trac/wiki/TitleIndex">Index by Title</a></li>

        <li><a href="/trac/wiki/RecentChanges">Index by Date</a></li>
        <li class="last">
          <a href="/trac/wiki/Documentation?action=diff&amp;version=15">Last Change</a>
        </li>
        -->
      </ul>
      <hr />
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div id="current-docs-container" style="display: none">
            <em>
              <a id="current-docs-link">
                Go to the latest version of this document.
              </a>
            </em>
          </div>
          <div class="body">
            
  <div class="section" id="writing-tests-for-twisted-code-using-trial">
<h1>Writing tests for Twisted code using Trial<a class="headerlink" href="#writing-tests-for-twisted-code-using-trial" title="Permalink to this headline">¶</a></h1>
<div class="section" id="trial-basics">
<h2>Trial basics<a class="headerlink" href="#trial-basics" title="Permalink to this headline">¶</a></h2>
<p><strong>Trial</strong> is Twisted&#8217;s testing framework.  It provides a
library for writing test cases and utility functions for working with the
Twisted environment in your tests, and a command-line utility for running your
tests. Trial is built on the Python standard library&#8217;s <code class="docutils literal"><span class="pre">unittest</span></code>
module. For more information on how Trial finds tests, see the
<a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.trial.runner.TestLoader.loadModule.html">loadModule</a> documentation.</p>
<p>To run all the Twisted tests, do:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> trial twisted
</pre></div>
</div>
<p>Refer to the Trial man page for other command-line options.</p>
</div>
<div class="section" id="trial-directories">
<h2>Trial directories<a class="headerlink" href="#trial-directories" title="Permalink to this headline">¶</a></h2>
<p>You might notice a new <code class="docutils literal"><span class="pre">_trial_temp</span></code> folder in the
current working directory after Trial completes the tests. This folder is the
working directory for the Trial process. It can be used by unit tests and
allows them to write whatever data they like to disk, and not worry
about polluting the current working directory.</p>
<p>Folders named <code class="docutils literal"><span class="pre">_trial_temp-&lt;counter&gt;</span></code> are
created if two instances of Trial are run in parallel from the same directory,
so as to avoid giving two different test-runs the same temporary directory.</p>
<p>The <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.python.lockfile.html">twisted.python.lockfile</a> utility is used to lock
the <code class="docutils literal"><span class="pre">_trial_temp</span></code> directories. On Linux, this results
in symlinks to pids. On Windows, directories are created with a single file with
a pid as the contents. These lock files will be cleaned up if Trial exits normally
and otherwise they will be left behind. They should be cleaned up the next time
Trial tries to use the directory they lock, but it&#8217;s also safe to delete them
manually if desired.</p>
</div>
<div class="section" id="twisted-specific-quirks-reactor-deferreds-calllater">
<h2>Twisted-specific quirks: reactor, Deferreds, callLater<a class="headerlink" href="#twisted-specific-quirks-reactor-deferreds-calllater" title="Permalink to this headline">¶</a></h2>
<p>The standard Python <code class="docutils literal"><span class="pre">unittest</span></code> framework, from which Trial is
derived, is ideal for testing code with a fairly linear flow of control.
Twisted is an asynchronous networking framework which provides a clean,
sensible way to establish functions that are run in response to events (like
timers and incoming data), which creates a highly non-linear flow of control.
Trial has a few extensions which help to test this kind of code. This section
provides some hints on how to use these extensions and how to best structure
your tests.</p>
<div class="section" id="leave-the-reactor-as-you-found-it">
<h3>Leave the Reactor as you found it<a class="headerlink" href="#leave-the-reactor-as-you-found-it" title="Permalink to this headline">¶</a></h3>
<p>Trial runs the entire test suite (over four thousand tests) in a single
process, with a single reactor. Therefore it is important that your test
leave the reactor in the same state as it found it. Leftover timers may
expire during somebody else&#8217;s unsuspecting test. Leftover connection attempts
may complete (and fail) during a later test. These lead to intermittent
failures that wander from test to test and are very time-consuming to track
down.</p>
<p>If your test leaves event sources in the reactor, Trial will fail the test.
The <code class="docutils literal"><span class="pre">tearDown</span></code> method is a good place to put cleanup code: it is
always run regardless of whether your test passes or fails (like a <code class="docutils literal"><span class="pre">finally</span></code>
clause in a try-except-finally construct). Exceptions in <code class="docutils literal"><span class="pre">tearDown</span></code>
are flagged as errors and flunk the test.
<a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.trial.unittest.TestCase.addCleanup.html">TestCase.addCleanup</a> is
another useful tool for cleaning up.  With it, you can register callables to
clean up resources as the test allocates them.  Generally, code should be
written so that only resources allocated in the tests need to be cleaned up in
the tests.  Resources which are allocated internally by the implementation
should be cleaned up by the implementation.</p>
<p>If your code uses Deferreds or depends on the reactor running, you can
return a Deferred from your test method, setUp, or tearDown and Trial will
do the right thing. That is, it will run the reactor for you until the
Deferred has triggered and its callbacks have been run. Don&#8217;t use
<code class="docutils literal"><span class="pre">reactor.run()</span></code> , <code class="docutils literal"><span class="pre">reactor.stop()</span></code> , <code class="docutils literal"><span class="pre">reactor.crash()</span></code> or <code class="docutils literal"><span class="pre">reactor.iterate()</span></code> in your tests.</p>
<p>Calls to <code class="docutils literal"><span class="pre">reactor.callLater</span></code> create <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.interfaces.IDelayedCall.html">IDelayedCall</a> s.  These need to be run
or cancelled during a test, otherwise they will outlive the test.  This would
be bad, because they could interfere with a later test, causing confusing
failures in unrelated tests!  For this reason, Trial checks the reactor to make
sure there are no leftover <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.interfaces.IDelayedCall.html">IDelayedCall</a> s in the reactor after a
test, and will fail the test if there are.  The cleanest and simplest way to
make sure this all works is to return a Deferred from your test.</p>
<p>Similarly, sockets created during a test should be closed by the end of the
test.  This applies to both listening ports and client connections.  So, calls
to <code class="docutils literal"><span class="pre">reactor.listenTCP</span></code> (and <code class="docutils literal"><span class="pre">listenUNIX</span></code> , and so on)
return <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.interfaces.IListeningPort.html">IListeningPort</a> s, and these should be
cleaned up before a test ends by calling their <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.interfaces.IListeningPort.stopListening.html">stopListening</a> method.
Calls to <code class="docutils literal"><span class="pre">reactor.connectTCP</span></code> return <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.interfaces.IConnector.html">IConnector</a> s, which should be cleaned
up by calling their <a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.interfaces.IConnector.disconnect.html">disconnect</a> method.  Trial
will warn about unclosed sockets.</p>
<p>The golden rule is: If your tests call a function which returns a Deferred,
your test should return a Deferred.</p>
</div>
<div class="section" id="using-timers-to-detect-failing-tests">
<h3>Using Timers to Detect Failing Tests<a class="headerlink" href="#using-timers-to-detect-failing-tests" title="Permalink to this headline">¶</a></h3>
<p>It is common for tests to establish some kind of fail-safe timeout that
will terminate the test in case something unexpected has happened and none of
the normal test-failure paths are followed. This timeout puts an upper bound
on the time that a test can consume, and prevents the entire test suite from
stalling because of a single test. This is especially important for the
Twisted test suite, because it is run automatically by the buildbot whenever
changes are committed to the Subversion repository.</p>
<p>The way to do this in Trial is to set the <code class="docutils literal"><span class="pre">.timeout</span></code> attribute
on your unit test method.  Set the attribute to the number of seconds you wish
to elapse before the test raises a timeout error.  Trial has a default timeout
which will be applied even if the <code class="docutils literal"><span class="pre">timeout</span></code> attribute is not set.
The Trial default timeout is usually sufficient and should be overridden only
in unusual cases.</p>
</div>
<div class="section" id="interacting-with-warnings-in-tests">
<h3>Interacting with warnings in tests<a class="headerlink" href="#interacting-with-warnings-in-tests" title="Permalink to this headline">¶</a></h3>
<p>Trial includes specific support for interacting with Python&#8217;s
<code class="docutils literal"><span class="pre">warnings</span></code> module.  This support allows warning-emitting code to
be written test-driven, just as any other code would be.  It also improves
the way in which warnings reporting when a test suite is running.</p>
<p><a class="api reference external" href="https://twistedmatrix.com/documents/15.4.0/api/twisted.trial.unittest.TestCase.flushWarnings.html">TestCase.flushWarnings</a>
allows tests to be written which make assertions about what warnings have
been emitted during a particular test method. In order to test a warning with
<code class="docutils literal"><span class="pre">flushWarnings</span></code> , write a test which first invokes the code which
will emit a warning and then calls <code class="docutils literal"><span class="pre">flushWarnings</span></code> and makes
assertions about the result.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SomeWarningsTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;foo is bad&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flushWarnings</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Warnings emitted in tests which are not flushed will be included by the
default reporter in its output after the result of the test.  If Python&#8217;s
warnings filter system (see <a class="reference external" href="http://docs.python.org/using/cmdline.html#cmdoption-unittest-discover-W">the-W command option to Python</a> ) is configured to treat a warning as an error,
then unflushed warnings will causes tests to fail and will be included in
the summary section of the default reporter.  Note that unlike usual
operation, when <code class="docutils literal"><span class="pre">warnings.warn</span></code> is called as part of a test
method, it will not raise an exception when warnings have been configured as
errors.  However, if called outside of a test method (for example, at module
scope in a test module or a module imported by a test module) then it
<em>will</em> raise an exception.</p>
</div>
<div class="section" id="parallel-test">
<h3>Parallel test<a class="headerlink" href="#parallel-test" title="Permalink to this headline">¶</a></h3>
<p>In many situations, your unit tests may run faster if they are allowed to
run in parallel, such that blocking I/O calls allow other tests to continue.
Trial, like unittest, supports the -j parameter.  Run <code class="docutils literal"><span class="pre">trial</span> <span class="pre">-j</span> <span class="pre">3</span></code>
to run 3 test runners at the same time.</p>
<p>This requires care in your test creation.  Obviously, you need to ensure that
your code is otherwise content to work in a parallel fashion while working within
Twisted... and if you are using weird global variables in places, parallel tests
might reveal this.</p>
<p>However, if you have a test that fires up a schema on an external database
in the <code class="docutils literal"><span class="pre">setUp</span></code> function, does some operations on it in the test, and
then deletes that schema in the tearDown function, your tests will behave in an
unpredictable fashion as they tromp upon each other if they have their own
schema.  And this won&#8217;t actually indicate a real error in your code, merely a
testing-specific race-condition.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Writing tests for Twisted code using Trial</a><ul>
<li><a class="reference internal" href="#trial-basics">Trial basics</a></li>
<li><a class="reference internal" href="#trial-directories">Trial directories</a></li>
<li><a class="reference internal" href="#twisted-specific-quirks-reactor-deferreds-calllater">Twisted-specific quirks: reactor, Deferreds, callLater</a><ul>
<li><a class="reference internal" href="#leave-the-reactor-as-you-found-it">Leave the Reactor as you found it</a></li>
<li><a class="reference internal" href="#using-timers-to-detect-failing-tests">Using Timers to Detect Failing Tests</a></li>
<li><a class="reference internal" href="#interacting-with-warnings-in-tests">Interacting with warnings in tests</a></li>
<li><a class="reference internal" href="#parallel-test">Parallel test</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="dirdbm.html"
                                  title="previous chapter">DirDBM: Directory-based Storage</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="sendmsg.html"
                                  title="next chapter">Extremely Low-Level Socket Operations</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../../_sources/core/howto/testing.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../search.html" method="get">
                <p>
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
                </p>
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    </div>
    <div id="footer"><hr />
      <div>

</div>
      <p class="left2">
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

      </p>
      <p class="right"></p>
    </div>
    <script type="text/javascript">
      if (window.location.pathname.indexOf('/current/') == -1) {
          <!-- Give the user a link to this page, but in the current version of the docs. -->
          var link = document.getElementById('current-docs-link');
          link.href = window.location.pathname.replace(/\/\d+\.\d+\.\d+/, '/current');
          <!-- And make it visible -->
          var container = document.getElementById('current-docs-container');
          container.style.display = '';
          delete link;
          delete container;
      }
    </script>
  </body>
</html>