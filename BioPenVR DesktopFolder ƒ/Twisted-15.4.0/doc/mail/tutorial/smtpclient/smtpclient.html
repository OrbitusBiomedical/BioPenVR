<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Twisted Mail Tutorial: Building an SMTP Client from Scratch &mdash; Twisted 15.4.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/twistedtrac.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '15.4.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Twisted 15.4.0 documentation" href="../../../index.html" />
    <link rel="up" title="Twisted Mail" href="../../index.html" />
    <link rel="next" title="Twisted Names" href="../../../names/index.html" />
    <link rel="prev" title="Sending Mail" href="../../howto/sending-mail.html" /> 
    
<!-- Can stuff between these comments go? -->
        <link rel="search" href="/trac/search" />
        <link rel="help" href="/trac/wiki/TracGuide" />
        <link rel="alternate" href="/trac/wiki/Documentation?format=txt" type="text/x-trac-wiki" title="Plain Text" />
        <link rel="start" href="/trac/wiki" />

        
    <script type="text/javascript" src="/trac/chrome/common/js/jquery.js"></script><script type="text/javascript" src="/trac/chrome/common/js/trac.js"></script><script type="text/javascript" src="/trac/chrome/common/js/search.js"></script>
    
    <!-- the following script tag is a holdover frome Trac, which shouldn't be needed in Sphinx
    <script type="text/javascript">
      $(document).ready(function() {
        $("#content").find("h1,h2,h3,h4,h5,h6").addAnchor("Link to this section");
      });
    </script>
    -->
<!-- Can stuff between these comments go? -->

  </head>
  
  
<body>

<div id="banner">
<div id="top_grad">
         
</div>
<div id="tab">
        <a href="http://twistedmatrix.com/trac/wiki">HOME</a>
    <a href="http://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
    <a href="/">DOCS</a>
    <a href="http://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>

</div>
      <div id="header">
        <a id="logo" href="http://twistedmatrix.com/trac/"><img src="../../../_static/trac_banner.png" alt="Twisted" /></a>
      </div>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <form id="topsearch" action="/trac/search" method="get"><div>
        <label for="proj-search">Search:</label>
        <input type="text" id="proj-search" name="q" size="10" value="" />
        <input type="submit" value="Search" />
        <input type="hidden" name="wiki" value="on" />

        <input type="hidden" name="changeset" value="on" />
        <input type="hidden" name="ticket" value="on" />
      </div></form>
      -->
      <div id="metanav" class="nav">
    <ul>
      <li> </li>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <li class="first">logged in as khorn</li><li class=""><a href="/trac/logout">Logout</a></li><li class=""><a href="/trac/wiki/TracGuide">Help/Guide</a></li><li class=""><a href="/trac/about">About Trac</a></li><li class="last"><a href="/trac/account">My Account</a></li>
      -->
    </ul>
  </div>
    </div>

<!-- mainnav -->
    <div id="mainnav" class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../names/index.html" title="Twisted Names"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../../howto/sending-mail.html" title="Sending Mail"
             accesskey="P">previous</a> |</li>
        <li><a href="../../../index.html">Twisted 15.4.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Twisted Mail</a> &raquo;</li> 
      </ul>
    </div>

    <div id="main">
    <div id="ctxtnav" class="nav">
      <h2>Wiki Navigation</h2>
      <ul>
        <li>
        
        </li>
        <!-- taking this out for now, but might use 
             the space for something else later 
        -->
        <!--
        <li><a href="/trac/wiki/WikiStart">Start Page</a></li>
        <li><a href="/trac/wiki/TitleIndex">Index by Title</a></li>

        <li><a href="/trac/wiki/RecentChanges">Index by Date</a></li>
        <li class="last">
          <a href="/trac/wiki/Documentation?action=diff&amp;version=15">Last Change</a>
        </li>
        -->
      </ul>
      <hr />
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div id="current-docs-container" style="display: none">
            <em>
              <a id="current-docs-link">
                Go to the latest version of this document.
              </a>
            </em>
          </div>
          <div class="body">
            
  <div class="section" id="twisted-mail-tutorial-building-an-smtp-client-from-scratch">
<h1>Twisted Mail Tutorial: Building an SMTP Client from Scratch<a class="headerlink" href="#twisted-mail-tutorial-building-an-smtp-client-from-scratch" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This tutorial will walk you through the creation of an extremely
simple SMTP client application.  By the time the tutorial is complete,
you will understand how to create and start a TCP client speaking the
SMTP protocol, have it connect to an appropriate mail exchange server,
and transmit a message for delivery.</p>
<p>For the majority of this tutorial, <code class="docutils literal"><span class="pre">twistd</span></code> will be used
to launch the application.  Near the end we will explore other
possibilities for starting a Twisted application.  Until then, make
sure that you have <code class="docutils literal"><span class="pre">twistd</span></code> installed and conveniently
accessible for use in running each of the example <code class="docutils literal"><span class="pre">.tac</span></code>
files.</p>
<div class="section" id="smtp-client-1">
<h3>SMTP Client 1<a class="headerlink" href="#smtp-client-1" title="Permalink to this headline">¶</a></h3>
<p>The first step is to create <a class="reference download internal" href="../../../_downloads/smtpclient-1.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-1.tac</span></code></a> possible for use by <code class="docutils literal"><span class="pre">twistd</span></code> .</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">service</span>
</pre></div>
</div>
<p>The first line of the <code class="docutils literal"><span class="pre">.tac</span></code> file
imports <code class="docutils literal"><span class="pre">twisted.application.service</span></code> , a module which
contains many of the basic <em>service</em> classes and helper
functions available in Twisted.  In particular, we will be using
the <code class="docutils literal"><span class="pre">Application</span></code> function to create a new <em>application service</em> .  An <em>application service</em> simply acts as a
central object on which to store certain kinds of deployment
configuration.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">application</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="s">&quot;SMTP Client Tutorial&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The second line of the <code class="docutils literal"><span class="pre">.tac</span></code> file creates a
new <em>application service</em> and binds it to the local
name <code class="docutils literal"><span class="pre">application</span></code> .  <code class="docutils literal"><span class="pre">twistd</span></code> requires this
local name in each <code class="docutils literal"><span class="pre">.tac</span></code> file it runs.  It uses various
pieces of configuration on the object to determine its behavior.  For
example, <code class="docutils literal"><span class="pre">&quot;SMTP</span> <span class="pre">Client</span> <span class="pre">Tutorial&quot;</span></code> will be used as the name
of the <code class="docutils literal"><span class="pre">.tap</span></code> file into which to serialize application
state, should it be necessary to do so.</p>
<p>That does it for the first example.  We now have enough of
a <code class="docutils literal"><span class="pre">.tac</span></code> file to pass to <code class="docutils literal"><span class="pre">twistd</span></code> .  If we
run <a class="reference download internal" href="../../../_downloads/smtpclient-1.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-1.tac</span></code></a> using
the <code class="docutils literal"><span class="pre">twistd</span></code> command line:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">twistd</span> <span class="o">-</span><span class="n">ny</span> <span class="n">smtpclient</span><span class="o">-</span><span class="mf">1.</span><span class="n">tac</span>
</pre></div>
</div>
<p>we are rewarded with the following output:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$</span> twistd -ny smtpclient-1.tac
<span class="go">18:31 EST [-] Log opened.</span>
<span class="go">18:31 EST [-] twistd 2.0.0 (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">18:31 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">18:31 EST [-] Loading smtpclient-1.tac...</span>
<span class="go">18:31 EST [-] Loaded.</span>
</pre></div>
</div>
<p>As we expected, not much is going on.  We can shutdown this server
by issuing <code class="docutils literal"><span class="pre">^C</span></code> :</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">18:34 EST [-] Received SIGINT, shutting down.</span>
<span class="go">18:34 EST [-] Main loop terminated.</span>
<span class="go">18:34 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$</span>
</pre></div>
</div>
</div>
<div class="section" id="smtp-client-2">
<h3>SMTP Client 2<a class="headerlink" href="#smtp-client-2" title="Permalink to this headline">¶</a></h3>
<p>The first version of our SMTP client wasn&#8217;t very interesting.  It
didn&#8217;t even establish any TCP connections!  The <a class="reference download internal" href="../../../_downloads/smtpclient-2.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-2.tac</span></code></a> will come a little bit
closer to that level of complexity.  First, we need to import a few
more things:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">internet</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">twisted.application.internet</span></code> is
another <em>application service</em> module.  It provides services for
establishing outgoing connections (as well as creating network
servers, though we are not interested in those parts for the
moment). <code class="docutils literal"><span class="pre">twisted.internet.protocol</span></code> provides base
implementations of many of the core Twisted concepts, such
as <em>factories</em> and <em>protocols</em> .</p>
<p>The next line of <a class="reference download internal" href="../../../_downloads/smtpclient-2.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-2.tac</span></code></a>
instantiates a new <em>client factory</em> .</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">smtpClientFactory</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">()</span>
</pre></div>
</div>
<p><em>Client factories</em> are responsible for
constructing <em>protocol instances</em> whenever connections are
established.  They may be required to create just one instance, or
many instances if many different connections are established, or they
may never be required to create one at all, if no connection ever
manages to be established.</p>
<p>Now that we have a client factory, we&#8217;ll need to hook it up to the
network somehow.  The next line of <code class="docutils literal"><span class="pre">smtpclient-2.tac</span></code> does
just that:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">smtpClientService</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPClient</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">smtpClientFactory</span><span class="p">)</span>
</pre></div>
</div>
<p>We&#8217;ll ignore the first two arguments
to <code class="docutils literal"><span class="pre">internet.TCPClient</span></code> for the moment and instead focus on
the third.  <code class="docutils literal"><span class="pre">TCPClient</span></code> is one of those <em>application service</em> classes.  It creates TCP connections to a specified
address and then uses its third argument, a <em>client factory</em> ,
to get a <em>protocol instance</em> .  It then associates the TCP
connection with the protocol instance and gets out of the way.</p>
<p>We can try to run <code class="docutils literal"><span class="pre">smtpclient-2.tac</span></code> the same way we
ran <code class="docutils literal"><span class="pre">smtpclient-1.tac</span></code> , but the results might be a little
disappointing:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$</span> twistd -ny smtpclient-2.tac
<span class="go">18:55 EST [-] Log opened.</span>
<span class="go">18:55 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">18:55 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">18:55 EST [-] Loading smtpclient-2.tac...</span>
<span class="go">18:55 EST [-] Loaded.</span>
<span class="go">18:55 EST [-] Starting factory &lt;twisted.internet.protocol.ClientFactory</span>
<span class="go">              instance at 0xb791e46c&gt;</span>
<span class="go">18:55 EST [-] Traceback (most recent call last):</span>
<span class="go">          File &quot;twisted/scripts/twistd.py&quot;, line 187, in runApp</span>
<span class="go">            app.runReactorWithLogging(config, oldstdout, oldstderr)</span>
<span class="go">          File &quot;twisted/application/app.py&quot;, line 128, in runReactorWithLogging</span>
<span class="go">            reactor.run()</span>
<span class="go">          File &quot;twisted/internet/posixbase.py&quot;, line 200, in run</span>
<span class="go">            self.mainLoop()</span>
<span class="go">          File &quot;twisted/internet/posixbase.py&quot;, line 208, in mainLoop</span>
<span class="go">            self.runUntilCurrent()</span>
<span class="go">        --- &lt;exception caught here&gt; ---</span>
<span class="go">          File &quot;twisted/internet/base.py&quot;, line 533, in runUntilCurrent</span>
<span class="go">            call.func(*call.args, **call.kw)</span>
<span class="go">          File &quot;twisted/internet/tcp.py&quot;, line 489, in resolveAddress</span>
<span class="go">            if abstract.isIPAddress(self.addr[0]):</span>
<span class="go">          File &quot;twisted/internet/abstract.py&quot;, line 315, in isIPAddress</span>
<span class="go">            parts = string.split(addr, &#39;.&#39;)</span>
<span class="go">          File &quot;/usr/lib/python2.4/string.py&quot;, line 292, in split</span>
<span class="go">            return s.split(sep, maxsplit)</span>
<span class="go">        exceptions.AttributeError: &#39;NoneType&#39; object has no attribute &#39;split&#39;</span>

<span class="go">18:55 EST [-] Received SIGINT, shutting down.</span>
<span class="go">18:55 EST [-] Main loop terminated.</span>
<span class="go">18:55 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$</span>
</pre></div>
</div>
<p>What happened?  Those first two arguments to <code class="docutils literal"><span class="pre">TCPClient</span></code>
turned out to be important after all.  We&#8217;ll get to them in the next
example.</p>
</div>
<div class="section" id="smtp-client-3">
<h3>SMTP Client 3<a class="headerlink" href="#smtp-client-3" title="Permalink to this headline">¶</a></h3>
<p>Version three of our SMTP client only changes one thing.  The line
from version two:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">smtpClientService</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPClient</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">smtpClientFactory</span><span class="p">)</span>
</pre></div>
</div>
<p>has its first two arguments changed from <code class="docutils literal"><span class="pre">None</span></code> to
something with a bit more meaning:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">smtpClientService</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPClient</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">smtpClientFactory</span><span class="p">)</span>
</pre></div>
</div>
<p>This directs the client to connect to <em>localhost</em> on
port <em>25</em> .  This isn&#8217;t the address we want ultimately, but it&#8217;s
a good place-holder for the time being.  We can
run <a class="reference download internal" href="../../../_downloads/smtpclient-3.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-3.tac</span></code></a> and see what this
change gets us:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$</span> twistd -ny smtpclient-3.tac
<span class="go">19:10 EST [-] Log opened.</span>
<span class="go">19:10 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">19:10 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">19:10 EST [-] Loading smtpclient-3.tac...</span>
<span class="go">19:10 EST [-] Loaded.</span>
<span class="go">19:10 EST [-] Starting factory &lt;twisted.internet.protocol.ClientFactory</span>
<span class="go">              instance at 0xb791e48c&gt;</span>
<span class="go">19:10 EST [-] Enabling Multithreading.</span>
<span class="go">19:10 EST [Uninitialized] Traceback (most recent call last):</span>
<span class="go">          File &quot;twisted/python/log.py&quot;, line 56, in callWithLogger</span>
<span class="go">            return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)</span>
<span class="go">          File &quot;twisted/python/log.py&quot;, line 41, in callWithContext</span>
<span class="go">            return context.call({ILogContext: newCtx}, func, *args, **kw)</span>
<span class="go">          File &quot;twisted/python/context.py&quot;, line 52, in callWithContext</span>
<span class="go">            return self.currentContext().callWithContext(ctx, func, *args, **kw)</span>
<span class="go">          File &quot;twisted/python/context.py&quot;, line 31, in callWithContext</span>
<span class="go">            return func(*args,**kw)</span>
<span class="go">        --- &lt;exception caught here&gt; ---</span>
<span class="go">          File &quot;twisted/internet/selectreactor.py&quot;, line 139, in _doReadOrWrite</span>
<span class="go">            why = getattr(selectable, method)()</span>
<span class="go">          File &quot;twisted/internet/tcp.py&quot;, line 543, in doConnect</span>
<span class="go">            self._connectDone()</span>
<span class="go">          File &quot;twisted/internet/tcp.py&quot;, line 546, in _connectDone</span>
<span class="go">            self.protocol = self.connector.buildProtocol(self.getPeer())</span>
<span class="go">          File &quot;twisted/internet/base.py&quot;, line 641, in buildProtocol</span>
<span class="go">            return self.factory.buildProtocol(addr)</span>
<span class="go">          File &quot;twisted/internet/protocol.py&quot;, line 99, in buildProtocol</span>
<span class="go">            p = self.protocol()</span>
<span class="go">        exceptions.TypeError: &#39;NoneType&#39; object is not callable</span>

<span class="go">19:10 EST [Uninitialized] Stopping factory</span>
<span class="go">          &lt;twisted.internet.protocol.ClientFactory instance at</span>
<span class="go">          0xb791e48c&gt;</span>
<span class="go">19:10 EST [-] Received SIGINT, shutting down.</span>
<span class="go">19:10 EST [-] Main loop terminated.</span>
<span class="go">19:10 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$</span>
</pre></div>
</div>
<p>A meagre amount of progress, but the service still raises an
exception.  This time, it&#8217;s because we haven&#8217;t specified
a <em>protocol class</em> for the factory to use.  We&#8217;ll do that in
the next example.</p>
</div>
<div class="section" id="smtp-client-4">
<h3>SMTP Client 4<a class="headerlink" href="#smtp-client-4" title="Permalink to this headline">¶</a></h3>
<p>In the previous example, we ran into a problem because we hadn&#8217;t
set up our <em>client factory&#8217;s</em> <em>protocol</em> attribute
correctly (or at all).  <code class="docutils literal"><span class="pre">ClientFactory.buildProtocol</span></code> is
the method responsible for creating a <em>protocol instance</em> .  The
default implementation calls the factory&#8217;s <code class="docutils literal"><span class="pre">protocol</span></code> attribute,
adds itself as an attribute named <code class="docutils literal"><span class="pre">factory</span></code> to the
resulting instance, and returns it.  In <a class="reference download internal" href="../../../_downloads/smtpclient-4.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-4.tac</span></code></a> , we&#8217;ll correct the
oversight that caused the traceback in smtpclient-3.tac:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">smtpClientFactory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">Protocol</span>
</pre></div>
</div>
<p>Running this version of the client, we can see the output is once
again traceback free:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span> twistd -ny smtpclient-4.tac
<span class="go">19:29 EST [-] Log opened.</span>
<span class="go">19:29 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">19:29 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">19:29 EST [-] Loading smtpclient-4.tac...</span>
<span class="go">19:29 EST [-] Loaded.</span>
<span class="go">19:29 EST [-] Starting factory &lt;twisted.internet.protocol.ClientFactory</span>
<span class="go">              instance at 0xb791e4ac&gt;</span>
<span class="go">19:29 EST [-] Enabling Multithreading.</span>
<span class="go">19:29 EST [-] Received SIGINT, shutting down.</span>
<span class="go">19:29 EST [Protocol,client] Stopping factory</span>
<span class="go">          &lt;twisted.internet.protocol.ClientFactory instance at</span>
<span class="go">          0xb791e4ac&gt;</span>
<span class="go">19:29 EST [-] Main loop terminated.</span>
<span class="go">19:29 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span>
</pre></div>
</div>
<p>But what does this
mean? <code class="docutils literal"><span class="pre">twisted.internet.protocol.Protocol</span></code> is the
base <em>protocol</em> implementation.  For those familiar with the
classic UNIX network services, it is equivalent to
the <em>discard</em> service.  It never produces any output and it
discards all its input.  Not terribly useful, and certainly nothing
like an SMTP client.  Let&#8217;s see how we can improve this in the next
example.</p>
</div>
<div class="section" id="smtp-client-5">
<h3>SMTP Client 5<a class="headerlink" href="#smtp-client-5" title="Permalink to this headline">¶</a></h3>
<p>In <a class="reference download internal" href="../../../_downloads/smtpclient-5.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-5.tac</span></code></a> , we will begin
to use Twisted&#8217;s SMTP protocol implementation for the first time.
We&#8217;ll make the obvious change, simply swapping
out <code class="docutils literal"><span class="pre">twisted.internet.protocol.Protocol</span></code> in favor
of <code class="docutils literal"><span class="pre">twisted.mail.smtp.ESMTPClient</span></code> .  Don&#8217;t worry about
the <em>E</em> in <em>ESMTP</em> .  It indicates we&#8217;re actually using a
newer version of the SMTP protocol.  There is
an <code class="docutils literal"><span class="pre">SMTPClient</span></code> in Twisted, but there&#8217;s essentially no
reason to ever use it.</p>
<p>smtpclient-5.tac adds a new import:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.mail</span> <span class="kn">import</span> <span class="n">smtp</span>
</pre></div>
</div>
<p>All of the mail related code in Twisted exists beneath
the <code class="docutils literal"><span class="pre">twisted.mail</span></code> package.  More specifically, everything
having to do with the SMTP protocol implementation is defined in
the <code class="docutils literal"><span class="pre">twisted.mail.smtp</span></code> module.</p>
<p>Next we remove a line we added in smtpclient-4.tac:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">smtpClientFactory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">Protocol</span>
</pre></div>
</div>
<p>And add a similar one in its place:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">smtpClientFactory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">smtp</span><span class="o">.</span><span class="n">ESMTPClient</span>
</pre></div>
</div>
<p>Our client factory is now using a protocol implementation which
behaves as an SMTP client.  What happens when we try to run this
version?</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span> twistd -ny smtpclient-5.tac
<span class="go">19:42 EST [-] Log opened.</span>
<span class="go">19:42 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">19:42 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">19:42 EST [-] Loading smtpclient-5.tac...</span>
<span class="go">19:42 EST [-] Loaded.</span>
<span class="go">19:42 EST [-] Starting factory &lt;twisted.internet.protocol.ClientFactory</span>
<span class="go">              instance at 0xb791e54c&gt;</span>
<span class="go">19:42 EST [-] Enabling Multithreading.</span>
<span class="go">19:42 EST [Uninitialized] Traceback (most recent call last):</span>
<span class="go">          File &quot;twisted/python/log.py&quot;, line 56, in callWithLogger</span>
<span class="go">            return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)</span>
<span class="go">          File &quot;twisted/python/log.py&quot;, line 41, in callWithContext</span>
<span class="go">            return context.call({ILogContext: newCtx}, func, *args, **kw)</span>
<span class="go">          File &quot;twisted/python/context.py&quot;, line 52, in callWithContext</span>
<span class="go">            return self.currentContext().callWithContext(ctx, func, *args, **kw)</span>
<span class="go">          File &quot;twisted/python/context.py&quot;, line 31, in callWithContext</span>
<span class="go">            return func(*args,**kw)</span>
<span class="go">        --- &lt;exception caught here&gt; ---</span>
<span class="go">          File &quot;twisted/internet/selectreactor.py&quot;, line 139, in _doReadOrWrite</span>
<span class="go">            why = getattr(selectable, method)()</span>
<span class="go">          File &quot;twisted/internet/tcp.py&quot;, line 543, in doConnect</span>
<span class="go">            self._connectDone()</span>
<span class="go">          File &quot;twisted/internet/tcp.py&quot;, line 546, in _connectDone</span>
<span class="go">            self.protocol = self.connector.buildProtocol(self.getPeer())</span>
<span class="go">          File &quot;twisted/internet/base.py&quot;, line 641, in buildProtocol</span>
<span class="go">            return self.factory.buildProtocol(addr)</span>
<span class="go">          File &quot;twisted/internet/protocol.py&quot;, line 99, in buildProtocol</span>
<span class="go">            p = self.protocol()</span>
<span class="go">        exceptions.TypeError: __init__() takes at least 2 arguments (1 given)</span>

<span class="go">19:42 EST [Uninitialized] Stopping factory</span>
<span class="go">          &lt;twisted.internet.protocol.ClientFactory instance at</span>
<span class="go">          0xb791e54c&gt;</span>
<span class="go">19:43 EST [-] Received SIGINT, shutting down.</span>
<span class="go">19:43 EST [-] Main loop terminated.</span>
<span class="go">19:43 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span>
</pre></div>
</div>
<p>Oops, back to getting a traceback.  This time, the default
implementation of <code class="docutils literal"><span class="pre">buildProtocol</span></code> seems no longer to be
sufficient.  It instantiates the protocol with no arguments,
but <code class="docutils literal"><span class="pre">ESMTPClient</span></code> wants at least one argument.  In the next
version of the client, we&#8217;ll override <code class="docutils literal"><span class="pre">buildProtocol</span></code> to
fix this problem.</p>
</div>
<div class="section" id="smtp-client-6">
<h3>SMTP Client 6<a class="headerlink" href="#smtp-client-6" title="Permalink to this headline">¶</a></h3>
<p><a class="reference download internal" href="../../../_downloads/smtpclient-6.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-6.tac</span></code></a> introduces
a <code class="docutils literal"><span class="pre">twisted.internet.protocol.ClientFactory</span></code> subclass with
an overridden <code class="docutils literal"><span class="pre">buildProtocol</span></code> method to overcome the
problem encountered in the previous example.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SMTPClientFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">smtp</span><span class="o">.</span><span class="n">ESMTPClient</span>

    <span class="k">def</span> <span class="nf">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">(</span><span class="n">secret</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">identity</span><span class="o">=</span><span class="s">&#39;example.com&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The overridden method does almost the same thing as the base
implementation: the only change is that it passes values for two
arguments to <code class="docutils literal"><span class="pre">twisted.mail.smtp.ESMTPClient</span></code> &#8216;s initializer.
The <code class="docutils literal"><span class="pre">secret</span></code> argument is used for SMTP authentication
(which we will not attempt yet).  The <code class="docutils literal"><span class="pre">identity</span></code> argument
is used as a to identify ourselves Another minor change to note is
that the <code class="docutils literal"><span class="pre">protocol</span></code> attribute is now defined in the class
definition, rather than tacked onto an instance after one is created.
This means it is a class attribute, rather than an instance attribute,
now, which makes no difference as far as this example is concerned.
There are circumstances in which the difference is important: be sure
you understand the implications of each approach when creating your
own factories.</p>
<p>One other change is required: instead of
instantiating <code class="docutils literal"><span class="pre">twisted.internet.protocol.ClientFactory</span></code> , we
will now instantiate <code class="docutils literal"><span class="pre">SMTPClientFactory</span></code> :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">smtpClientFactory</span> <span class="o">=</span> <span class="n">SMTPClientFactory</span><span class="p">()</span>
</pre></div>
</div>
<p>Running this version of the code, we observe that the
code <strong>still</strong> isn&#8217;t quite traceback-free.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span> twistd -ny smtpclient-6.tac
<span class="go">21:17 EST [-] Log opened.</span>
<span class="go">21:17 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">21:17 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">21:17 EST [-] Loading smtpclient-6.tac...</span>
<span class="go">21:17 EST [-] Loaded.</span>
<span class="go">21:17 EST [-] Starting factory &lt;__builtin__.SMTPClientFactory instance</span>
<span class="go">              at 0xb77fd68c&gt;</span>
<span class="go">21:17 EST [-] Enabling Multithreading.</span>
<span class="go">21:17 EST [ESMTPClient,client] Traceback (most recent call last):</span>
<span class="go">          File &quot;twisted/python/log.py&quot;, line 56, in callWithLogger</span>
<span class="go">            return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)</span>
<span class="go">          File &quot;twisted/python/log.py&quot;, line 41, in callWithContext</span>
<span class="go">            return context.call({ILogContext: newCtx}, func, *args, **kw)</span>
<span class="go">          File &quot;twisted/python/context.py&quot;, line 52, in callWithContext</span>
<span class="go">            return self.currentContext().callWithContext(ctx, func, *args, **kw)</span>
<span class="go">          File &quot;twisted/python/context.py&quot;, line 31, in callWithContext</span>
<span class="go">            return func(*args,**kw)</span>
<span class="go">        --- &lt;exception caught here&gt; ---</span>
<span class="go">          File &quot;twisted/internet/selectreactor.py&quot;, line 139, in _doReadOrWrite</span>
<span class="go">            why = getattr(selectable, method)()</span>
<span class="go">          File &quot;twisted/internet/tcp.py&quot;, line 351, in doRead</span>
<span class="go">            return self.protocol.dataReceived(data)</span>
<span class="go">          File &quot;twisted/protocols/basic.py&quot;, line 221, in dataReceived</span>
<span class="go">            why = self.lineReceived(line)</span>
<span class="go">          File &quot;twisted/mail/smtp.py&quot;, line 1039, in lineReceived</span>
<span class="go">            why = self._okresponse(self.code,&#39;\n&#39;.join(self.resp))</span>
<span class="go">          File &quot;twisted/mail/smtp.py&quot;, line 1281, in esmtpState_serverConfig</span>
<span class="go">            self.tryTLS(code, resp, items)</span>
<span class="go">          File &quot;twisted/mail/smtp.py&quot;, line 1294, in tryTLS</span>
<span class="go">            self.authenticate(code, resp, items)</span>
<span class="go">          File &quot;twisted/mail/smtp.py&quot;, line 1343, in authenticate</span>
<span class="go">            self.smtpState_from(code, resp)</span>
<span class="go">          File &quot;twisted/mail/smtp.py&quot;, line 1062, in smtpState_from</span>
<span class="go">            self._from = self.getMailFrom()</span>
<span class="go">          File &quot;twisted/mail/smtp.py&quot;, line 1137, in getMailFrom</span>
<span class="go">            raise NotImplementedError</span>
<span class="go">        exceptions.NotImplementedError:</span>

<span class="go">21:17 EST [ESMTPClient,client] Stopping factory</span>
<span class="go">          &lt;__builtin__.SMTPClientFactory instance at 0xb77fd68c&gt;</span>
<span class="go">21:17 EST [-] Received SIGINT, shutting down.</span>
<span class="go">21:17 EST [-] Main loop terminated.</span>
<span class="go">21:17 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span>
</pre></div>
</div>
<p>What we have accomplished with this iteration of the example is to
navigate far enough into an SMTP transaction that Twisted is now
interested in calling back to application-level code to determine what
its next step should be.  In the next example, we&#8217;ll see how to
provide that information to it.</p>
</div>
<div class="section" id="smtp-client-7">
<h3>SMTP Client 7<a class="headerlink" href="#smtp-client-7" title="Permalink to this headline">¶</a></h3>
<p>SMTP Client 7 is the first version of our SMTP client which
actually includes message data to transmit.  For simplicity&#8217;s sake,
the message is defined as part of a new class.  In a useful program
which sent email, message data might be pulled in from the filesystem,
a database, or be generated based on
user-input.  <a class="reference download internal" href="../../../_downloads/smtpclient-7.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-7.tac</span></code></a> , however,
defines a new class, <code class="docutils literal"><span class="pre">SMTPTutorialClient</span></code> , with three class
attributes (<code class="docutils literal"><span class="pre">mailFrom</span></code> , <code class="docutils literal"><span class="pre">mailTo</span></code> ,
and <code class="docutils literal"><span class="pre">mailData</span></code> ):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SMTPTutorialClient</span><span class="p">(</span><span class="n">smtp</span><span class="o">.</span><span class="n">ESMTPClient</span><span class="p">):</span>
    <span class="n">mailFrom</span> <span class="o">=</span> <span class="s">&quot;tutorial_sender@example.com&quot;</span>
    <span class="n">mailTo</span> <span class="o">=</span> <span class="s">&quot;tutorial_recipient@example.net&quot;</span>
    <span class="n">mailData</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">Date: Fri, 6 Feb 2004 10:14:39 -0800</span>
<span class="s">From: Tutorial Guy &lt;tutorial_sender@example.com&gt;</span>
<span class="s">To: Tutorial Gal &lt;tutorial_recipient@example.net&gt;</span>
<span class="s">Subject: Tutorate!</span>

<span class="s">Hello, how are you, goodbye.</span>
<span class="s">&#39;&#39;&#39;</span>
</pre></div>
</div>
<p>This statically defined data is accessed later in the class
definition by three of the methods which are part of the
<em>SMTPClient callback API</em> .  Twisted expects each of the three
methods below to be defined and to return an object with a particular
meaning.  First, <code class="docutils literal"><span class="pre">getMailFrom</span></code> :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">getMailFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailFrom</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mailFrom</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>This method is called to determine the <em>reverse-path</em> ,
otherwise known as the <em>envelope from</em> , of the message.  This
value will be used when sending the <code class="docutils literal"><span class="pre">MAIL</span> <span class="pre">FROM</span></code> SMTP
command.  The method must return a string which conforms to the <a class="reference external" href="http://www.faqs.org/rfcs/rfc2821.html">RFC 2821</a> definition
of a <em>reverse-path</em> .  In simpler terms, it should be a string
like <code class="docutils literal"><span class="pre">&quot;alice&#64;example.com&quot;</span></code> .  Only one <em>envelope from</em> is allowed by the SMTP protocol, so it cannot be a list of
strings or a comma separated list of addresses.  Our implementation
of <code class="docutils literal"><span class="pre">getMailFrom</span></code> does a little bit more than just return a
string; we&#8217;ll get back to this in a little bit.</p>
<p>The next method is <code class="docutils literal"><span class="pre">getMailTo</span></code> :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">getMailTo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mailTo</span><span class="p">]</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">getMailTo</span></code> is similar to <code class="docutils literal"><span class="pre">getMailFrom</span></code> .  It
returns one or more RFC 2821 addresses (this time a
<em>forward-path</em> , or <em>envelope to</em> ).  Since SMTP allows
multiple recipients, <code class="docutils literal"><span class="pre">getMailTo</span></code> returns a list of these
addresses.  The list must contain at least one address, and even if
there is exactly one recipient, it must still be in a list.</p>
<p>The final callback we will define to provide information to
Twisted is <code class="docutils literal"><span class="pre">getMailData</span></code> :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">getMailData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mailData</span><span class="p">)</span>
</pre></div>
</div>
<p>This one is quite simple as well: it returns a file or a file-like
object which contains the message contents.  In our case, we return
a <code class="docutils literal"><span class="pre">StringIO</span></code> since we already have a string containing our
message.  If the contents of the file returned
by <code class="docutils literal"><span class="pre">getMailData</span></code> span multiple lines (as email messages
often do), the lines should be <code class="docutils literal"><span class="pre">\n</span></code> delimited (as they
would be when opening a text file in the <code class="docutils literal"><span class="pre">&quot;rt&quot;</span></code> mode):
necessary newline translation will be performed
by <code class="docutils literal"><span class="pre">SMTPClient</span></code> automatically.</p>
<p>There is one more new callback method defined in smtpclient-7.tac.
This one isn&#8217;t for providing information about the messages to
Twisted, but for Twisted to provide information about the success or
failure of the message transmission to the application:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sentMail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">numOk</span><span class="p">,</span> <span class="n">addresses</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;Sent&#39;</span><span class="p">,</span> <span class="n">numOk</span><span class="p">,</span> <span class="s">&#39;messages&#39;</span>
</pre></div>
</div>
<p>Each of the arguments to <code class="docutils literal"><span class="pre">sentMail</span></code> provides some
information about the success or failure of the message transmission
transaction.  <code class="docutils literal"><span class="pre">code</span></code> is the response code from the ultimate
command.  For successful transactions, it will be 250.  For transient
failures (those which should be retried), it will be between 400 and
499, inclusive.  For permanent failures (this which will never work,
no matter how many times you retry them), it will be between 500 and
599.</p>
</div>
<div class="section" id="smtp-client-8">
<h3>SMTP Client 8<a class="headerlink" href="#smtp-client-8" title="Permalink to this headline">¶</a></h3>
<p>Thus far we have succeeded in creating a Twisted client application
which starts up, connects to a (possibly) remote host, transmits some
data, and disconnects.  Notably missing, however, is application
shutdown.  Hitting ^C is fine during development, but it&#8217;s not exactly
a long-term solution.  Fortunately, programmatic shutdown is extremely
simple.  <a class="reference download internal" href="../../../_downloads/smtpclient-8.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-8.tac</span></code></a>
extends <code class="docutils literal"><span class="pre">sentMail</span></code> with these two lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">stop</span></code> method of the reactor causes the main event
loop to exit, allowing a Twisted server to shut down.  With this
version of the example, we see that the program actually terminates
after sending the message, without user-intervention:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span> twistd -ny smtpclient-8.tac
<span class="go">19:52 EST [-] Log opened.</span>
<span class="go">19:52 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">19:52 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">19:52 EST [-] Loading smtpclient-8.tac...</span>
<span class="go">19:52 EST [-] Loaded.</span>
<span class="go">19:52 EST [-] Starting factory &lt;__builtin__.SMTPClientFactory instance</span>
<span class="go">              at 0xb791beec&gt;</span>
<span class="go">19:52 EST [-] Enabling Multithreading.</span>
<span class="go">19:52 EST [SMTPTutorialClient,client] Sent 1 messages</span>
<span class="go">19:52 EST [SMTPTutorialClient,client] Stopping factory</span>
<span class="go">          &lt;__builtin__.SMTPClientFactory instance at 0xb791beec&gt;</span>
<span class="go">19:52 EST [-] Main loop terminated.</span>
<span class="go">19:52 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span>
</pre></div>
</div>
</div>
<div class="section" id="smtp-client-9">
<h3>SMTP Client 9<a class="headerlink" href="#smtp-client-9" title="Permalink to this headline">¶</a></h3>
<p>One task remains to be completed in this tutorial SMTP client:
instead of always sending mail through a well-known host, we will look
up the mail exchange server for the recipient address and try to
deliver the message to that host.</p>
<p>In <a class="reference download internal" href="../../../_downloads/smtpclient-9.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-9.tac</span></code></a> , we&#8217;ll take the
first step towards this feature by defining a function which returns
the mail exchange host for a particular domain:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">getMailExchange</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;localhost&#39;</span>
</pre></div>
</div>
<p>Obviously this doesn&#8217;t return the correct mail exchange host yet
(in fact, it returns the exact same host we have been using all
along), but pulling out the logic for determining which host to
connect to into a function like this is the first step towards our
ultimate goal.  Now that we have <code class="docutils literal"><span class="pre">getMailExchange</span></code> , we&#8217;ll
call it when constructing our <code class="docutils literal"><span class="pre">TCPClient</span></code> service:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">smtpClientService</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPClient</span><span class="p">(</span>
    <span class="n">getMailExchange</span><span class="p">(</span><span class="s">&#39;example.net&#39;</span><span class="p">),</span> <span class="mi">25</span><span class="p">,</span> <span class="n">smtpClientFactory</span><span class="p">)</span>
</pre></div>
</div>
<p>We&#8217;ll expand on the definition of <code class="docutils literal"><span class="pre">getMailExchange</span></code> in
the next example.</p>
</div>
<div class="section" id="smtp-client-10">
<h3>SMTP Client 10<a class="headerlink" href="#smtp-client-10" title="Permalink to this headline">¶</a></h3>
<p>In the previous example we defined <code class="docutils literal"><span class="pre">getMailExchange</span></code> to
return a string representing the mail exchange host for a particular
domain.  While this was a step in the right direction, it turns out
not to be a very big one.  Determining the mail exchange host for a
particular domain is going to involve network traffic (specifically,
some DNS requests).  These might take an arbitrarily large amount of
time, so we need to introduce a <code class="docutils literal"><span class="pre">Deferred</span></code> to represent the
result of <code class="docutils literal"><span class="pre">getMailExchange</span></code> .  <a class="reference download internal" href="../../../_downloads/smtpclient-10.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-10.tac</span></code></a> redefines it
thusly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">getMailExchange</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">defer.succeed</span></code> is a function which creates a
new <code class="docutils literal"><span class="pre">Deferred</span></code> which already has a result, in this
case <code class="docutils literal"><span class="pre">'localhost'</span></code> .  Now we need to adjust
our <code class="docutils literal"><span class="pre">TCPClient</span></code> -constructing code to expect and properly
handle this <code class="docutils literal"><span class="pre">Deferred</span></code> :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">cbMailExchange</span><span class="p">(</span><span class="n">exchange</span><span class="p">):</span>
    <span class="n">smtpClientFactory</span> <span class="o">=</span> <span class="n">SMTPClientFactory</span><span class="p">()</span>

    <span class="n">smtpClientService</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPClient</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">smtpClientFactory</span><span class="p">)</span>
    <span class="n">smtpClientService</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>

<span class="n">getMailExchange</span><span class="p">(</span><span class="s">&#39;example.net&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">cbMailExchange</span><span class="p">)</span>
</pre></div>
</div>
<p>An in-depth exploration of <code class="docutils literal"><span class="pre">Deferred</span></code> s is beyond the
scope of this document.  For such a look, see
the <a class="reference external" href="../../../core/howto/defer.html">Deferred Reference</a> <code class="docutils literal"><span class="pre">TCPClient</span></code> until the <code class="docutils literal"><span class="pre">Deferred</span></code>
returned by <code class="docutils literal"><span class="pre">getMailExchange</span></code> fires.  Once it does, we
proceed normally through the creation of
our <code class="docutils literal"><span class="pre">SMTPClientFactory</span></code> and <code class="docutils literal"><span class="pre">TCPClient</span></code> , as well
as set the <code class="docutils literal"><span class="pre">TCPClient</span></code> &#8216;s service parent, just as we did in
the previous examples.</p>
</div>
<div class="section" id="smtp-client-11">
<h3>SMTP Client 11<a class="headerlink" href="#smtp-client-11" title="Permalink to this headline">¶</a></h3>
<p>At last we&#8217;re ready to perform the mail exchange lookup.  We do
this by calling on an object provided specifically for this
task, <code class="docutils literal"><span class="pre">twisted.mail.relaymanager.MXCalculator</span></code> :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">getMailExchange</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">cbMX</span><span class="p">(</span><span class="n">mxRecord</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">mxRecord</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">relaymanager</span><span class="o">.</span><span class="n">MXCalculator</span><span class="p">()</span><span class="o">.</span><span class="n">getMX</span><span class="p">(</span><span class="n">host</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">cbMX</span><span class="p">)</span>
</pre></div>
</div>
<p>Because <code class="docutils literal"><span class="pre">getMX</span></code> returns a <code class="docutils literal"><span class="pre">Record_MX</span></code> object
rather than a string, we do a little bit of post-processing to get the
results we want.  We have already converted the rest of the tutorial
application to expect a <code class="docutils literal"><span class="pre">Deferred</span></code>
from <code class="docutils literal"><span class="pre">getMailExchange</span></code> , so no further changes are
required.  <a class="reference download internal" href="../../../_downloads/smtpclient-11.tac"><code class="xref download docutils literal"><span class="pre">smtpclient-11.tac</span></code></a> completes
this tutorial by being able to both look up the mail exchange host for
the recipient domain, connect to it, complete an SMTP transaction,
report its results, and finally shut down the reactor.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../../../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Twisted Mail Tutorial: Building an SMTP Client from Scratch</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a><ul>
<li><a class="reference internal" href="#smtp-client-1">SMTP Client 1</a></li>
<li><a class="reference internal" href="#smtp-client-2">SMTP Client 2</a></li>
<li><a class="reference internal" href="#smtp-client-3">SMTP Client 3</a></li>
<li><a class="reference internal" href="#smtp-client-4">SMTP Client 4</a></li>
<li><a class="reference internal" href="#smtp-client-5">SMTP Client 5</a></li>
<li><a class="reference internal" href="#smtp-client-6">SMTP Client 6</a></li>
<li><a class="reference internal" href="#smtp-client-7">SMTP Client 7</a></li>
<li><a class="reference internal" href="#smtp-client-8">SMTP Client 8</a></li>
<li><a class="reference internal" href="#smtp-client-9">SMTP Client 9</a></li>
<li><a class="reference internal" href="#smtp-client-10">SMTP Client 10</a></li>
<li><a class="reference internal" href="#smtp-client-11">SMTP Client 11</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="../../howto/sending-mail.html"
                                  title="previous chapter">Sending Mail</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="../../../names/index.html"
                                  title="next chapter">Twisted Names</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../../../_sources/mail/tutorial/smtpclient/smtpclient.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../search.html" method="get">
                <p>
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
                </p>
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    </div>
    <div id="footer"><hr />
      <div>

</div>
      <p class="left2">
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

      </p>
      <p class="right"></p>
    </div>
    <script type="text/javascript">
      if (window.location.pathname.indexOf('/current/') == -1) {
          <!-- Give the user a link to this page, but in the current version of the docs. -->
          var link = document.getElementById('current-docs-link');
          link.href = window.location.pathname.replace(/\/\d+\.\d+\.\d+/, '/current');
          <!-- And make it visible -->
          var container = document.getElementById('current-docs-container');
          container.style.display = '';
          delete link;
          delete container;
      }
    </script>
  </body>
</html>